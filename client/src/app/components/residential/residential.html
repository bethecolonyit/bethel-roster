<div class="residential-wrapper">
  <mat-card class="residential-card">
    <mat-card-header>
      <div mat-card-avatar class="residential-icon">
        <mat-icon>apartment</mat-icon>
      </div>
      <mat-card-title>Residential Management</mat-card-title>
      <mat-card-subtitle>
        Buildings • Rooms • Beds • Occupancy
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div *ngIf="loading">
        Loading residential structure...
      </div>

      <div *ngIf="error" class="error">
        {{ error }}
      </div>

      <ng-container *ngIf="!loading && !error">
        <div *ngIf="buildings.length === 0">
          No residential data found. Add buildings, rooms, and beds on the
          backend.
        </div>

        <!-- BUILDINGS -->
        <mat-accordion
          *ngIf="buildings.length > 0"
          multi="true"
          class="buildings-accordion"
        >
          <mat-expansion-panel
            *ngFor="let building of buildings"
            class="building-panel"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ building.buildingName }}
              </mat-panel-title>
              <mat-panel-description>
                {{ building.occupiedBeds }}/{{ building.totalBeds }}
                occupied • {{ building.availableBeds }} available
              </mat-panel-description>
            </mat-expansion-panel-header>

            <!-- ROOMS -->
            <div *ngIf="building.rooms.length === 0" class="empty-msg">
              No rooms defined for this building.
            </div>

            <mat-accordion
              *ngIf="building.rooms.length > 0"
              multi="true"
              class="rooms-accordion"
            >
              <mat-expansion-panel
                *ngFor="let room of building.rooms"
                class="room-panel"
              >
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Room {{ room.roomNumber }} ({{ room.roomType }})
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ room.occupiedBeds }}/{{ room.totalBeds }} occupied •
                    {{ room.availableBeds }} available
                  </mat-panel-description>
                </mat-expansion-panel-header>
                <!-- BEDS -->
<div class="beds-list">
  <div class="bed-row" *ngFor="let bed of room.beds">
    <div class="bed-row-main">
      <div class="bed-row-header">
        <div class="bed-header-left">
          <mat-icon class="bed-icon">
            {{ bed.occupancy ? 'person' : 'single_bed' }}
          </mat-icon>

          <div class="bed-title">
            Bed {{ bed.bedLetter }}
          </div>
        </div>

        <div class="bed-actions">
          <!-- Checkout button for occupied beds -->
          <button
            mat-icon-button
            color="warn"
            *ngIf="bed.occupancy"
            (click)="onCheckoutClick(building, room, bed, $event)"
            matTooltip="Checkout / unassign"
          >
            <mat-icon>logout</mat-icon>
          </button>

          <!-- Assign button for available beds -->
          <button
            mat-icon-button
            color="primary"
            *ngIf="!bed.occupancy"
            (click)="onAssignClick(building, room, bed, $event)"
            matTooltip="Assign student to this bed"
          >
            <mat-icon>person_add</mat-icon>
          </button>
        </div>
      </div>

      <div class="bed-row-body">
        <div
          class="bed-line"
          *ngIf="bed.occupancy && bed.occupancy.student"
        >
          {{ bed.occupancy.student.firstName }}
          {{ bed.occupancy.student.lastName }}
          <span class="since">
            • since {{ bed.occupancy.startDate | date: 'MMM d, y' }}
          </span>
        </div>

        <div class="bed-line" *ngIf="!bed.occupancy">
          <span class="available-label">Available</span>
        </div>

        <!-- Inline assign panel for THIS bed -->
        <div
          *ngIf="assigningContext && assigningContext.bedId === bed.id"
          class="assign-inline-panel"
        >
          <p class="assign-subtitle">
            Assigning to Room {{ room.roomNumber }} ({{ room.roomType }}) •
            Bed {{ bed.bedLetter }}
          </p>

          <div *ngIf="studentsLoading">
            Loading students.
          </div>

          <div *ngIf="!studentsLoading && studentsLoaded">
            <mat-form-field appearance="outline" class="assign-field">
              <mat-label>Search student</mat-label>
              <input
                type="text"
                matInput
                [formControl]="studentSearchControl"
                [matAutocomplete]="studentAuto"
              />
            </mat-form-field>

            <mat-autocomplete
              #studentAuto="matAutocomplete"
              (optionSelected)="onStudentSelected($event.option.value)"
            >
              <mat-option
                *ngFor="let s of filteredStudents"
                [value]="s"
              >
                {{ s.lastName }}, {{ s.firstName }} ({{ s.idNumber }})
              </mat-option>
            </mat-autocomplete>

            <div class="assign-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="confirmAssign()"
                [disabled]="!selectedStudent"
              >
                Assign
              </button>
              <button mat-button type="button" (click)="cancelAssign()">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


              </mat-expansion-panel>
            </mat-accordion>
          </mat-expansion-panel>
        </mat-accordion>
      </ng-container>
    </mat-card-content>

    <mat-card-actions>
      <button mat-stroked-button (click)="loadStructure()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </mat-card-actions>
  </mat-card>
</div>
