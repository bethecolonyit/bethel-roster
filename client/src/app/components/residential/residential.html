<div class="residential-wrapper">
  <mat-card class="residential-card">
    <mat-card-header>
      <div mat-card-avatar class="residential-icon">
        <mat-icon>apartment</mat-icon>
      </div>
      <mat-card-title>Residential Management</mat-card-title>
      <mat-card-subtitle>
        Buildings â€¢ Rooms â€¢ Beds â€¢ Occupancy
      </mat-card-subtitle>
       <!-- spacer to push the icon to the right -->
      <span class="header-spacer"></span>

      <!--  Add building button -->
      <button
        mat-icon-button
        matTooltip="Add building"
        (click)="toggleCreateBuilding()"
        class="add-building-btn"
      >
        <mat-icon>add</mat-icon>
      </button>
    </mat-card-header>
    <!-- Create building form -->
    <div *ngIf="showCreateBuilding" class="create-building-panel">
      <form
        [formGroup]="createBuildingForm"
        (ngSubmit)="onCreateBuildingSubmit()"
        class="create-building-form"
      >
        <mat-form-field appearance="outline" class="create-building-field">
          <mat-label>Building name</mat-label>
          <input
            matInput
            formControlName="buildingName"
            autocomplete="off"
          />
          <mat-error
            *ngIf="
              createBuildingForm.controls.buildingName.touched &&
              createBuildingForm.controls.buildingName.hasError('required')
            "
          >
            Building name is required
          </mat-error>
        </mat-form-field>

        <div class="create-building-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="createBuildingForm.invalid || createBuildingLoading"
          >
            <mat-icon>check</mat-icon>
            Create
          </button>

          <button
            mat-button
            type="button"
            (click)="cancelCreateBuilding()"
            [disabled]="createBuildingLoading"
          >
            Cancel
          </button>
        </div>

        <div *ngIf="createBuildingLoading" class="subtle-status">
          Saving buildingâ€¦
        </div>
        <div *ngIf="createBuildingError" class="error">
          {{ createBuildingError }}
        </div>
      </form>
    </div>

    <mat-card-content>
      <div *ngIf="loading">
        Loading residential structure...
      </div>

      <div *ngIf="error" class="error">
        {{ error }}
      </div>

      <ng-container *ngIf="!loading && !error">
        <div *ngIf="buildings.length === 0">
          No residential data found. Add buildings, rooms, and beds on the
          backend.
        </div>

        <!-- BUILDINGS -->
        <mat-accordion
          *ngIf="buildings.length > 0"
          multi="true"
          class="buildings-accordion"
        >
          <mat-expansion-panel
            *ngFor="let building of buildings"
            class="building-panel"
            #buildingPanel="matExpansionPanel"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ building.buildingName }}
              </mat-panel-title>
              <mat-panel-description>
                {{ building.occupiedBeds }}/{{ building.totalBeds }}
                occupied â€¢ {{ building.availableBeds }} available
              </mat-panel-description>
              <!-- spacer to push icons right -->
              <span class="header-spacer"></span>

              <!-- Add Room button -->
              <button
                *ngIf="buildingPanel.expanded"
                mat-icon-button
                matTooltip="Add room"
                (click)="openCreateRoom(building, $event)"
              >
                <mat-icon>add</mat-icon>
              </button>
              <button
                *ngIf="!buildingPanel.expanded"
                mat-icon-button
                color="warn"
                matTooltip="Delete building (and all its rooms & beds)"
                [disabled]="building.occupiedBeds > 0"
                (click)="$event.stopPropagation(); onDeleteBuilding(building)"
              >
      <mat-icon>delete</mat-icon>
    </button>
            </mat-expansion-panel-header>
             <!-- ðŸ”¹ Shared Room form (create + edit) now at BUILDING level -->
            <div
              *ngIf="roomFormBuildingId === building.id"
              class="room-form-panel"
            >
              <form
                [formGroup]="roomForm"
                (ngSubmit)="onSubmitRoomForm()"
                class="room-form"
              >
                <mat-form-field appearance="outline" class="room-form-field">
                  <mat-label>Room number</mat-label>
                  <input
                    matInput
                    formControlName="roomNumber"
                    autocomplete="off"
                  />
                </mat-form-field>

                <mat-form-field appearance="outline" class="room-form-field">
                  <mat-label>Room type</mat-label>
                  <mat-select formControlName="roomType">
                    <mat-option value="student">Student</mat-option>
                    <mat-option value="staff">Staff</mat-option>
                    <mat-option value="vsp">VSP</mat-option>
                  </mat-select>
                </mat-form-field>

                <div class="room-form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="roomForm.invalid || roomFormLoading"
                  >
                    <mat-icon>check</mat-icon>
                    {{ roomFormMode === 'create' ? 'Create room' : 'Save changes' }}
                  </button>
                  <button
                    mat-button
                    type="button"
                    (click)="cancelRoomForm()"
                    [disabled]="roomFormLoading"
                  >
                    Cancel
                  </button>
                </div>

                <div *ngIf="roomFormLoading" class="subtle-status">
                  Savingâ€¦
                </div>
                <div *ngIf="roomFormError" class="error">
                  {{ roomFormError }}
                </div>
              </form>
            </div>
            <!-- ROOMS -->
            <div *ngIf="building.rooms.length === 0" class="empty-msg">
              No rooms defined for this building.
            </div>

            <mat-accordion
              *ngIf="building.rooms.length > 0"
              multi="true"
              class="rooms-accordion"
            >
              <mat-expansion-panel
                *ngFor="let room of building.rooms"
                class="room-panel"
                #roomPanel="matExpansionPanel"
              >
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Room {{ room.roomNumber }} ({{ room.roomType }})
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ room.occupiedBeds }}/{{ room.totalBeds }} occupied â€¢
                    {{ room.availableBeds }} available
                  </mat-panel-description>
                    <span class="header-spacer"></span>
                <!-- EDIT (collapsed only) -->
                <button
                  *ngIf="!roomPanel.expanded"
                  mat-icon-button
                  matTooltip="Edit room"
                  (click)="openEditRoom(building, room)"
                >
                  <mat-icon>edit</mat-icon>
                </button>

                <!-- DELETE (collapsed only) -->
                <button
                  *ngIf="!roomPanel.expanded"
                  mat-icon-button
                  color="warn"
                  matTooltip="Delete room"
                  [disabled]="room.occupiedBeds > 0"
                  (click)="$event.stopPropagation(); onDeleteRoom(building, room)"
                >
                  <mat-icon>delete</mat-icon>
                </button>

                <!-- ADD room (expanded only) â€“> opens same form in create mode -->
                <button
                  *ngIf="roomPanel.expanded"
                  mat-icon-button
                  matTooltip="Add bed"
                  (click)="openCreateBed(room, $event)"
                >
                  <mat-icon>add</mat-icon>
                </button>

                </mat-expansion-panel-header>
                <!-- ðŸ”¹ Shared Bed form (create + edit) at ROOM level -->
                <div *ngIf="bedFormRoomId === room.id" class="bed-form-panel">
                  <form
                    [formGroup]="bedForm"
                    (ngSubmit)="onSubmitBedForm(building, room)"
                    class="bed-form"
                  >
                    <mat-form-field appearance="outline" class="bed-form-field">
                      <mat-label>Bed letter</mat-label>
                      <input
                        matInput
                        formControlName="bedLetter"
                        autocomplete="off"
                        maxlength="2"
                      />
                      <mat-hint>Examples: A, B, C</mat-hint>
                      <mat-error
                        *ngIf="
                          bedForm.controls.bedLetter.touched &&
                          bedForm.controls.bedLetter.hasError('required')
                        "
                      >
                        Bed letter is required
                      </mat-error>
                    </mat-form-field>

                    <div class="bed-form-actions">
                      <button
                        mat-raised-button
                        color="primary"
                        type="submit"
                        [disabled]="bedForm.invalid || bedFormLoading"
                      >
                        <mat-icon>check</mat-icon>
                        {{ bedFormMode === 'create' ? 'Create bed' : 'Save changes' }}
                      </button>

                      <button
                        mat-button
                        type="button"
                        (click)="cancelBedForm()"
                        [disabled]="bedFormLoading"
                      >
                        Cancel
                      </button>
                    </div>

                    <div *ngIf="bedFormLoading" class="subtle-status">
                      Savingâ€¦
                    </div>
                    <div *ngIf="bedFormError" class="error">
                      {{ bedFormError }}
                    </div>
                  </form>
                </div>

                <!-- BEDS -->
                <div class="beds-list">
                  ...
                </div>

                <!-- BEDS -->
<div class="beds-list">
  <div class="bed-row" *ngFor="let bed of room.beds">
    <div class="bed-row-main">
      <div class="bed-row-header">
        <div class="bed-header-left">
          <mat-icon class="bed-icon">
            {{ bed.occupancy ? 'person' : 'single_bed' }}
          </mat-icon>

          <div class="bed-title">
            Bed {{ bed.bedLetter }}
          </div>
        </div>

        <div class="bed-actions">
          <!-- Checkout button for occupied beds -->
          <button
            mat-icon-button
            color="warn"
            *ngIf="bed.occupancy"
            (click)="onCheckoutClick(building, room, bed, $event)"
            matTooltip="Checkout / unassign"
          >
            <mat-icon>logout</mat-icon>
          </button>

          <!-- Assign button for available beds -->
          <button
            mat-icon-button
            color="primary"
            *ngIf="!bed.occupancy"
            (click)="onAssignClick(building, room, bed, $event)"
            matTooltip="Assign student to this bed"
          >
            <mat-icon>person_add</mat-icon>
          </button>
          <button
            mat-icon-button
            color="warn"
            *ngIf="!bed.occupancy"
            (click)="onDeleteBed(building, room, bed, $event)"
            matTooltip="Delete bed"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <div class="bed-row-body">
        <div
          class="bed-line"
          *ngIf="bed.occupancy && bed.occupancy.student"
        >
          {{ bed.occupancy.student.firstName }}
          {{ bed.occupancy.student.lastName }}
          <span class="since">
            â€¢ since {{ bed.occupancy.startDate | date: 'MMM d, y' }}
          </span>
        </div>

        <div class="bed-line" *ngIf="!bed.occupancy">
          <span class="available-label">Available</span>
        </div>

        <!-- Inline assign panel for THIS bed -->
        <div
          *ngIf="assigningContext && assigningContext.bedId === bed.id"
          class="assign-inline-panel"
        >
          <p class="assign-subtitle">
            Assigning to Room {{ room.roomNumber }} ({{ room.roomType }}) â€¢
            Bed {{ bed.bedLetter }}
          </p>

          <div *ngIf="studentsLoading">
            Loading students.
          </div>

          <div *ngIf="!studentsLoading && studentsLoaded">
            <mat-form-field appearance="outline" class="assign-field">
              <mat-label>Search student</mat-label>
              <input
                type="text"
                matInput
                [formControl]="studentSearchControl"
                [matAutocomplete]="studentAuto"
              />
            </mat-form-field>

            <mat-autocomplete
              #studentAuto="matAutocomplete"
              (optionSelected)="onStudentSelected($event.option.value)"
            >
              <mat-option
                *ngFor="let s of filteredStudents"
                [value]="s"
              >
                {{ s.lastName }}, {{ s.firstName }} ({{ s.id }})
              </mat-option>
            </mat-autocomplete>

            <div class="assign-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="confirmAssign()"
                [disabled]="!selectedStudent"
              >
                Assign
              </button>
              <button mat-button type="button" (click)="cancelAssign()">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
              </mat-expansion-panel>
            </mat-accordion>
          </mat-expansion-panel>
        </mat-accordion>
      </ng-container>
    </mat-card-content>

    <mat-card-actions>
      <button mat-stroked-button (click)="loadStructure()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </mat-card-actions>
  </mat-card>
</div>
