<div class="section-container">
  <mat-card class="section-card">
    <div class="card-header">
      <h2 class="card-title">HR Dashboard</h2>
      <span class="flex-spacer"></span>
      <button mat-stroked-button color="primary" (click)="refreshRequests()">
        Refresh Requests
      </button>
    </div>

    <mat-card-content>
      <mat-tab-group [(selectedIndex)]="selectedTabIndex">
        <!-- ========================= -->
        <!-- TAB 1: BALANCES -->
        <!-- ========================= -->
        <mat-tab label="Balances">
          <div class="tab-section">
            <div class="toolbar-row">
              <mat-form-field appearance="outline" class="employee-select">
                <mat-label>Select Employee</mat-label>
                <mat-select [value]="selectedEmployeeId" (selectionChange)="onEmployeeChanged($event.value)">
                  <mat-option [value]="null">-- Select --</mat-option>
                  <mat-option *ngFor="let e of employees" [value]="e.id">
                    {{ employeeName(e) }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <span class="flex-spacer"></span>

              <button
                mat-raised-button
                color="primary"
                (click)="saveAllTargets()"
                [disabled]="!selectedEmployeeId || isLoadingBalances || isSavingBalances"
              >
                Save Balances
              </button>
            </div>

            <div class="loading-row" *ngIf="isLoadingBalances">
              Loading balances...
            </div>

            <table class="assignment-table mat-elevation-z2" *ngIf="selectedEmployeeId && leaveTypes.length">
              <thead>
                <tr class="table-row">
                  <th>Leave Type</th>
                  <th>Current Hours</th>
                  <th class="target-col">Target Hours</th>
                </tr>
              </thead>

              <tbody>
                <tr class="table-row" *ngFor="let lt of leaveTypes">
                  <td>
                    <div class="type-cell">
                      <div class="type-code">{{ lt.code }}</div>
                      <div class="type-name">{{ lt.name }}</div>
                    </div>
                  </td>

                  <td>{{ getCurrentHours(lt.code) }}</td>

                  <td class="target-col">
                    <mat-form-field appearance="outline" class="hours-field">
                      <mat-label>Hours</mat-label>
                      <input
                        matInput
                        type="number"
                        min="0"
                        step="0.25"
                        [formControl]="form.controls[lt.code]"
                      />
                      <mat-error *ngIf="form.controls[lt.code].hasError('min')">
                        Must be 0 or greater
                      </mat-error>
                    </mat-form-field>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="hint" *ngIf="selectedEmployeeId && !leaveTypes.length">
              No leave types found. Seed PTO/SICK in app.leave_types.
            </div>
          </div>
        </mat-tab>

        <!-- ========================= -->
        <!-- TAB 2: REQUESTS -->
        <!-- ========================= -->
        <mat-tab label="Requests">
          <div class="tab-section">
            <div class="toolbar-row">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Status</mat-label>
                <mat-select [formControl]="requestFilters.status" (selectionChange)="refreshRequests()">
                  <mat-option value="">All</mat-option>
                  <mat-option value="Pending">Pending</mat-option>
                  <mat-option value="Approved">Approved</mat-option>
                  <mat-option value="Denied">Denied</mat-option>
                  <mat-option value="Cancelled">Cancelled</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Leave Type</mat-label>
                <mat-select [formControl]="requestFilters.leaveTypeCode" (selectionChange)="refreshRequests()">
                  <mat-option value="">All</mat-option>
                  <mat-option *ngFor="let lt of leaveTypes" [value]="lt.code">{{ lt.code }} - {{ lt.name }}</mat-option>
                </mat-select>
              </mat-form-field>

              <span class="flex-spacer"></span>

              <button mat-stroked-button color="primary" (click)="refreshRequests()" [disabled]="isLoadingRequests">
                Refresh
              </button>
            </div>

            <div class="loading-row" *ngIf="isLoadingRequests">Loading requests...</div>

            <table class="assignment-table mat-elevation-z2" *ngIf="requests.length">
              <thead>
                <tr class="table-row">
                  <th>Employee</th>
                  <th>Type</th>
                  <th>Dates</th>
                  <th>Hours</th>
                  <th>Status</th>
                  <th>Notes</th>
                  <th class="actions-col">Actions</th>
                </tr>
              </thead>

              <tbody>
                <tr class="table-row" *ngFor="let r of requests; trackBy: trackByRequestId">
                  <td>{{ r.employeeFirstName }} {{ r.employeeLastName }}</td>
                  <td>{{ r.leaveTypeCode }}</td>
                  <td>
                    <div class="date-range">
                      <div>{{ fmtDateTime(r.startDateTime) }}</div>
                      <div class="muted">to</div>
                      <div>{{ fmtDateTime(r.endDateTime) }}</div>
                    </div>
                  </td>
                  <td>{{ r.requestedHours }}</td>
                  <td>{{ r.status }}</td>
                  <td>{{ r.notes || '-' }}</td>

                  <td class="actions-col">
                    <ng-container *ngIf="r.status === 'Pending'; else nonPendingActions">
                      <button
                        mat-button
                        color="primary"
                        (click)="approve(r)"
                        [disabled]="requestBusy[r.id]"
                      >
                        Approve
                      </button>

                      <mat-form-field appearance="outline" class="deny-notes">
                        <mat-label>Deny notes (optional)</mat-label>
                        <input matInput [(ngModel)]="denyNotes[r.id]" [disabled]="requestBusy[r.id]" />
                      </mat-form-field>

                      <button
                        mat-button
                        color="warn"
                        (click)="deny(r)"
                        [disabled]="requestBusy[r.id]"
                      >
                        Deny
                      </button>
                    </ng-container>

                    <ng-template #nonPendingActions>
                      <button
                        mat-button
                        color="warn"
                        (click)="cancel(r)"
                        [disabled]="requestBusy[r.id]"
                      >
                        Cancel
                      </button>
                    </ng-template>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="hint" *ngIf="!isLoadingRequests && !requests.length">
              No requests found for the selected filters.
            </div>
          </div>
        </mat-tab>

        <!-- ========================= -->
        <!-- TAB 3: ADJUSTMENTS -->
        <!-- ========================= -->
        <mat-tab label="Adjustments">
          <div class="tab-section">
            <div class="toolbar-row">
              <div class="hint">
                Post a ledger adjustment (banked holiday, overtime, accrual, or manual correction). This updates balances immediately.
              </div>
            </div>

            <div class="adjust-grid">
              <mat-form-field appearance="outline">
                <mat-label>Employee</mat-label>
                <mat-select [formControl]="adjustmentForm.controls.employeeId">
                  <mat-option [value]="null">-- Select --</mat-option>
                  <mat-option *ngFor="let e of employees" [value]="e.id">
                    {{ employeeName(e) }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Leave Type</mat-label>
                <mat-select [formControl]="adjustmentForm.controls.leaveTypeCode">
                  <mat-option value="">-- Select --</mat-option>
                  <mat-option *ngFor="let lt of leaveTypes" [value]="lt.code">
                    {{ lt.code }} - {{ lt.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Hours (+/-)</mat-label>
                <input matInput type="number" step="0.25" [formControl]="adjustmentForm.controls.amountHours" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Source</mat-label>
                <mat-select [formControl]="adjustmentForm.controls.source">
                  <mat-option *ngFor="let s of sources" [value]="s">{{ s }}</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Effective Date (optional)</mat-label>
                <input matInput placeholder="YYYY-MM-DD" [formControl]="adjustmentForm.controls.effectiveDate" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="memo-field">
                <mat-label>Memo (optional)</mat-label>
                <input matInput [formControl]="adjustmentForm.controls.memo" />
              </mat-form-field>
            </div>

            <div class="toolbar-row">
              <span class="flex-spacer"></span>
              <button
                mat-raised-button
                color="primary"
                (click)="postAdjustment()"
                [disabled]="adjustmentForm.invalid || isPostingAdjustment"
              >
                Post Adjustment
              </button>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
