<div class="students-page">
  <mat-card class="students-card">
    <mat-card-header class="students-header">

      <!-- Title + Subtitle + Icon -->
      <div class="students-title">
        <div class="students-title-icon">
          <mat-icon>school</mat-icon>
        </div>

        <div class="students-title-text">
          <mat-card-title>Student Dashboard</mat-card-title>
          <mat-card-subtitle>View and manage enrolled students</mat-card-subtitle>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="students-header-actions">

        <!-- View toggle button -->
        <button
          mat-icon-button
          color="primary"
          (click)="toggleViewMode()"
          [attr.aria-label]="viewMode === 'grid' ? 'Switch to list view' : 'Switch to grid view'"
          matTooltip="Toggle view"
        >
          <mat-icon>
            {{ viewMode === 'grid' ? 'view_list' : 'grid_view' }}
          </mat-icon>
        </button>

        <!-- Sort button -->
        <button
          mat-icon-button
          color="primary"
          [matMenuTriggerFor]="sortMenu"
          aria-label="Sort options"
          matTooltip="{{ getSortLabel() }}"
        >
          <mat-icon>sort</mat-icon>
        </button>

        <mat-menu #sortMenu="matMenu">
          <button mat-menu-item (click)="setSort('alpha')">
            <mat-icon>sort_by_alpha</mat-icon>
            <span>Sort Alphabetical (First Name)</span>
          </button>

          <!-- Sort by Last Name -->
          <button mat-menu-item (click)="setSort('lastName')">
            <mat-icon>sort_by_alpha</mat-icon>
            <span>Sort Alphabetical (Last Name)</span>
          </button>

          <button mat-menu-item (click)="setSort('dayIn')">
            <mat-icon>schedule</mat-icon>
            <span>Sort by Day-In (most recent first)</span>
          </button>

          <button mat-menu-item (click)="setSort('dayOut')">
            <mat-icon>event</mat-icon>
            <span>Sort by DayOut (soonest first)</span>
          </button>

          <button mat-menu-item (click)="setSort('program')">
            <mat-icon>category</mat-icon>
            <span>Sort by Program</span>
          </button>
        </mat-menu>

        <!-- Filter button -->
        <button
          mat-icon-button
          color="primary"
          [matMenuTriggerFor]="filterMenu"
          aria-label="Filter options"
          matTooltip="{{ getFilterLabel() }}"
        >
          <mat-icon>filter_alt</mat-icon>
        </button>

        <!-- IMPORTANT: no overlayPanelClass/panelClass here (not supported in your Material version) -->
        <mat-menu #filterMenu="matMenu" class="students-filter-menu">

          <!-- Programs header -->
          <button mat-menu-item class="filter-section-header" disabled>
            Program
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox
              [(ngModel)]="filters.program['65 Day']"
              (change)="onFiltersChanged()"
            >
              65 Day
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox
              [(ngModel)]="filters.program['30 Day']"
              (change)="onFiltersChanged()"
            >
              30 Day
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox
              [(ngModel)]="filters.program['VSP']"
              (change)="onFiltersChanged()"
            >
              VSP
            </mat-checkbox>
          </button>

          <mat-divider></mat-divider>

          <!-- Flags header -->
          <button mat-menu-item class="filter-section-header" disabled>
            Flags (checked = must be true)
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="filters.isFelon" (change)="onFiltersChanged()">
              Felon
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="filters.onProbation" (change)="onFiltersChanged()">
              On Probation
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="filters.usesNicotine" (change)="onFiltersChanged()">
              Uses Nicotine
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="filters.hasDriverLicense" (change)="onFiltersChanged()">
              Has Driver License
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="filters.foodAllergies" (change)="onFiltersChanged()">
              Food Allergies
            </mat-checkbox>
          </button>

          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="filters.beeAllergies" (change)="onFiltersChanged()">
              Bee Allergies
            </mat-checkbox>
          </button>

          <mat-divider></mat-divider>

          <button mat-menu-item (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            <span>Clear filters</span>
          </button>
        </mat-menu>

        <!-- Add / Close button -->
        <button
          mat-icon-button
          color="primary"
          type="button"
          *ngIf="auth.isAdmin || auth.isOffice"
          (click)="toggleCreateStudent()"
          [attr.aria-label]="showCreateForm ? 'Hide create student form' : 'Show create student form'"
          matTooltip="{{ showCreateForm ? 'Close' : 'Add student' }}"
        >
          <mat-icon>{{ showCreateForm ? 'close' : 'add' }}</mat-icon>
        </button>
      </div>

      <!-- Search Box -->
      <mat-form-field class="students-search" appearance="outline">
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          placeholder="Search by name or file #"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchTermChange($event)"
        />
      </mat-form-field>

    </mat-card-header>

    <mat-card-content>

      <!-- Create student form -->
      <div *ngIf="showCreateForm" class="create-student-section">
        <app-create-student (studentCreated)="onStudentCreated()"></app-create-student>
      </div>

      <!-- Error -->
      <div *ngIf="error" class="error-message">
        <mat-icon>error_outline</mat-icon>
        <span>{{ error }}</span>
      </div>

      <!-- GRID VIEW -->
      <div class="grid-container" *ngIf="viewMode === 'grid' && filteredStudents.length > 0">
        <app-student-card
          *ngFor="let student of filteredStudents"
          [student]="student"
          (viewDetails)="onViewStudentDetails($event)"
          (createNote)="onCreateStudentNote($event)"
          (createWriteUp)="onCreateStudentWriteUp($event)"
        ></app-student-card>
      </div>

      <!-- LIST VIEW -->
      <app-student-list
        *ngIf="viewMode === 'list'"
        [students]="filteredStudents"
        [viewMode]="viewMode"
      ></app-student-list>

      <!-- Empty state -->
      <div class="empty-state" *ngIf="students.length === 0">
        <mat-icon>info</mat-icon>
        <span>No students found.</span>
      </div>

    </mat-card-content>
  </mat-card>
</div>
